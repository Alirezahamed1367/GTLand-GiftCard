# ğŸš€ Ø±Ø§Ù‡Ù†Ù…Ø§ÛŒ Ø³ÛŒØ³ØªÙ… Ù¾ÙˆÛŒØ§ (Dynamic Field Mapping System)

## ğŸ“‹ Ù…Ø¹Ø±ÙÛŒ

Ø§ÛŒÙ† Ø³ÛŒØ³ØªÙ… Ø¨Ù‡ Ø´Ù…Ø§ Ø§Ø¬Ø§Ø²Ù‡ Ù…ÛŒâ€ŒØ¯Ù‡Ø¯ ØªØ§ **Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± Ú©Ø¯**ØŒ Ø´ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù Ø¨Ø§ Ø³Ø§Ø®ØªØ§Ø±Ù‡Ø§ÛŒ Ù…ØªÙØ§ÙˆØª Ø±Ø§ Import Ùˆ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ú©Ù†ÛŒØ¯.

**Ù‚Ø§Ø¨Ù„ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ú©Ù„ÛŒØ¯ÛŒ:**
- âœ… ØªØ¹Ø±ÛŒÙ Ù†Ù‚Ø´ Ù‡Ø± Ø³ØªÙˆÙ† ØªÙˆØ³Ø· Ú©Ø§Ø±Ø¨Ø±
- âœ… Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ Ø§Ø² Ø´ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ø®Ø±ÛŒØ¯ØŒ ÙØ±ÙˆØ´ØŒ Ø¨ÙˆÙ†ÙˆØ³
- âœ… Ù¾Ù„ØªÙØ±Ù…â€ŒÙ‡Ø§ÛŒ Ù…ØªØ¹Ø¯Ø¯ (Roblox, Apple, Nintendo, ...)
- âœ… Ù…ØºØ§ÛŒØ±Øªâ€ŒÚ¯ÛŒØ±ÛŒ Ø³ÙˆØ¯ (Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´Ø¯Ù‡ vs Ù¾Ø±Ø³Ù†Ù„)
- âœ… Ú¯Ø²Ø§Ø±Ø´â€ŒØ³Ø§Ø² Ù¾ÛŒØ´Ø±ÙØªÙ‡ Ø¨Ø§ ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ Ù…ØªØ¹Ø¯Ø¯
- âœ… ØµØ§Ø¯Ø±Ø§Øª Ø¨Ù‡ Excel

---

## ğŸ—ï¸ Ù…Ø¹Ù…Ø§Ø±ÛŒ Ø³ÛŒØ³ØªÙ…

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Google Sheets (Ø´ÛŒØªâ€ŒÙ‡Ø§ÛŒ Ù…Ø®ØªÙ„Ù Ø¨Ø§ Ø³ØªÙˆÙ†â€ŒÙ‡Ø§ÛŒ Ù…ØªÙØ§ÙˆØª)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚ Import
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SheetImport + RawData (JSON)                           â”‚
â”‚  Ø°Ø®ÛŒØ±Ù‡ Ø®Ø§Ù… Ø¨Ø¯ÙˆÙ† ØªÙØ³ÛŒØ±                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Field Mapping Dialog (Ú©Ø§Ø±Ø¨Ø± ØªØ¹Ø±ÛŒÙ Ù…ÛŒâ€ŒÚ©Ù†Ø¯)             â”‚
â”‚  - Label â†’ account_id                                   â”‚
â”‚  - GOLD â†’ gold_quantity                                 â”‚
â”‚  - Cost â†’ purchase_cost                                 â”‚
â”‚  - ...                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  DynamicDataProcessor                                   â”‚
â”‚  Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¨Ø± Ø§Ø³Ø§Ø³ Mapping                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Account, AccountGold, AccountSilver, Sale              â”‚
â”‚  (Ù…Ø¯Ù„â€ŒÙ‡Ø§ÛŒ Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯)                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                       â”‚
                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  CalculationEngine + ReportBuilder                      â”‚
â”‚  Ù…Ø­Ø§Ø³Ø¨Ø§Øª Ùˆ Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š Ø¬Ø¯Ø§ÙˆÙ„ Ø¯ÛŒØªØ§Ø¨ÛŒØ³

### **1. SheetImport**
Ø°Ø®ÛŒØ±Ù‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´ÛŒØªâ€ŒÙ‡Ø§ÛŒ Import Ø´Ø¯Ù‡

| ÙÛŒÙ„Ø¯ | ØªÙˆØ¶ÛŒØ­ |
|------|-------|
| `id` | Ø´Ù†Ø§Ø³Ù‡ |
| `sheet_name` | Ù†Ø§Ù… Ø´ÛŒØª (Ù…Ø«Ù„ "Consumed", "Roblox Sales") |
| `sheet_type` | Ù†ÙˆØ¹: purchase / sale / bonus |
| `platform` | Ù¾Ù„ØªÙØ±Ù… (Ø¨Ø±Ø§ÛŒ ÙØ±ÙˆØ´): roblox, apple, ... |
| `total_rows` | ØªØ¹Ø¯Ø§Ø¯ Ø³Ø·Ø±Ù‡Ø§ |
| `processed_rows` | ØªØ¹Ø¯Ø§Ø¯ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø´Ø¯Ù‡ |

### **2. RawData**
Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø®Ø§Ù… Ø¨Ù‡ ØµÙˆØ±Øª JSON

| ÙÛŒÙ„Ø¯ | ØªÙˆØ¶ÛŒØ­ |
|------|-------|
| `id` | Ø´Ù†Ø§Ø³Ù‡ |
| `sheet_import_id` | Ø§Ø±Ø¬Ø§Ø¹ Ø¨Ù‡ SheetImport |
| `row_number` | Ø´Ù…Ø§Ø±Ù‡ Ø³Ø·Ø± |
| `data` | JSON: `{"Label": "A1054", "Gold": 535, ...}` |
| `processed` | Ø¢ÛŒØ§ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø´Ø¯Ù‡ØŸ |

### **3. FieldMapping**
Ù†Ù‚Ø´ Ù‡Ø± Ø³ØªÙˆÙ† (ØªØ¹Ø±ÛŒÙ Ø´Ø¯Ù‡ ØªÙˆØ³Ø· Ú©Ø§Ø±Ø¨Ø±)

| ÙÛŒÙ„Ø¯ | ØªÙˆØ¶ÛŒØ­ |
|------|-------|
| `sheet_import_id` | Ø§Ø±Ø¬Ø§Ø¹ Ø¨Ù‡ SheetImport |
| `source_column` | Ù†Ø§Ù… Ø³ØªÙˆÙ† Ø¯Ø± Ø´ÛŒØª (Ù…Ø«Ù„ "GOLD") |
| `target_field` | Ù†Ù‚Ø´ Ø¯Ø± Ø³ÛŒØ³ØªÙ… (Ù…Ø«Ù„ "gold_quantity") |
| `data_type` | Ù†ÙˆØ¹ Ø¯Ø§Ø¯Ù‡: text, decimal, integer, date |
| `is_required` | Ø¢ÛŒØ§ Ø§Ø¬Ø¨Ø§Ø±ÛŒ Ø§Ø³ØªØŸ |

### **4. Platform**
Ù¾Ù„ØªÙØ±Ù…â€ŒÙ‡Ø§ÛŒ ÙØ±ÙˆØ´

| ÙÛŒÙ„Ø¯ | ØªÙˆØ¶ÛŒØ­ |
|------|-------|
| `code` | Ú©Ø¯ (roblox, apple, nintendo, ...) |
| `name` | Ù†Ø§Ù… Ù†Ù…Ø§ÛŒØ´ÛŒ |
| `is_active` | ÙØ¹Ø§Ù„/ØºÛŒØ±ÙØ¹Ø§Ù„ |

### **5. Sale** (Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯Ù‡)
ÙØ±ÙˆØ´â€ŒÙ‡Ø§ Ø¨Ø§ Ù¾Ù„ØªÙØ±Ù…

| ÙÛŒÙ„Ø¯ Ø¬Ø¯ÛŒØ¯ | ØªÙˆØ¶ÛŒØ­ |
|-----------|-------|
| `platform` | Ù¾Ù„ØªÙØ±Ù… ÙØ±ÙˆØ´ |
| `staff_profit` | Ø³ÙˆØ¯ Ú¯Ø²Ø§Ø±Ø´ Ø´Ø¯Ù‡ ØªÙˆØ³Ø· Ù¾Ø±Ø³Ù†Ù„ |

---

## ğŸ¯ Ø¬Ø±ÛŒØ§Ù† Ú©Ø§Ø±

### **Ù…Ø±Ø­Ù„Ù‡ 1: Ù…Ø§ÛŒÚ¯Ø±ÛŒØ´Ù†**
```bash
python migrate_to_dynamic_system.py
```

Ø§ÛŒÙ† Ø§Ø³Ú©Ø±ÛŒÙ¾Øª:
- âœ… Ø¬Ø¯Ø§ÙˆÙ„ Ø¬Ø¯ÛŒØ¯ Ø±Ø§ Ø§ÛŒØ¬Ø§Ø¯ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
- âœ… Ù¾Ù„ØªÙØ±Ù…â€ŒÙ‡Ø§ÛŒ Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø±Ø§ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯

### **Ù…Ø±Ø­Ù„Ù‡ 2: Import Ø¯Ø§Ø¯Ù‡**
1. Ø§Ø² Ù…Ù†Ùˆ: **"Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù‡ÙˆØ´Ù…Ù†Ø¯"** Ø±Ø§ Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯
2. Ø´ÛŒØª Ú¯ÙˆÚ¯Ù„ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯
3. Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø¯Ø± `SheetImport` Ùˆ `RawData` Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯

### **Ù…Ø±Ø­Ù„Ù‡ 3: ØªØ¹Ø±ÛŒÙ Mapping**
1. Ø§Ø² Ù…Ù†Ùˆ: **"Field Mapping Manager"** Ø±Ø§ Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯
2. Ø´ÛŒØª Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯
3. Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø³ØªÙˆÙ†ØŒ Ù†Ù‚Ø´ Ø¢Ù† Ø±Ø§ Ù…Ø´Ø®Øµ Ú©Ù†ÛŒØ¯:
   - `Label` â†’ **account_id**
   - `GOLD` â†’ **gold_quantity**
   - `Cost` â†’ **purchase_cost**
   - `Free Silver` â†’ **silver_bonus**
   - ...

4. Ø±ÙˆÛŒ **"Ø°Ø®ÛŒØ±Ù‡ Mapping"** Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯

**Ù†Ú©ØªÙ‡:** Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ø§Ø² **"ØªØ´Ø®ÛŒØµ Ø®ÙˆØ¯Ú©Ø§Ø±"** Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯

### **Ù…Ø±Ø­Ù„Ù‡ 4: Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¯Ø§Ø¯Ù‡**
```python
from app.core.financial import DynamicDataProcessor
from app.models.financial import FinancialSessionLocal

session = FinancialSessionLocal()
processor = DynamicDataProcessor(session)

# Ù¾Ø±Ø¯Ø§Ø²Ø´ ÛŒÚ© Ø´ÛŒØª
stats = processor.process_sheet(sheet_import_id=1)

print(f"Ù…ÙˆÙÙ‚: {stats['processed']}")
print(f"Ø®Ø·Ø§: {stats['errors']}")
```

### **Ù…Ø±Ø­Ù„Ù‡ 5: ØªÙˆÙ„ÛŒØ¯ Ú¯Ø²Ø§Ø±Ø´**
```python
from app.core.financial import AdvancedReportBuilder

builder = AdvancedReportBuilder(session)

# Ú¯Ø²Ø§Ø±Ø´ Label
config = {
    'report_type': 'label',
    'filters': {'label': 'A1054'},
    'sort_by': 'Total Profit',
    'sort_order': 'desc'
}

df = builder.build_report(config)
print(df)

# ØµØ§Ø¯Ø±Ø§Øª Ø¨Ù‡ Excel
builder.export_to_excel(df, 'report.xlsx')
```

### **Ù…Ø±Ø­Ù„Ù‡ 6: Ø¨Ø±Ø±Ø³ÛŒ Ù…ØºØ§ÛŒØ±Øª**
```python
from app.core.financial import DiscrepancyChecker

checker = DiscrepancyChecker(session)
discrepancies = checker.check_all_accounts()

for disc in discrepancies:
    print(f"Label: {disc['label']}")
    print(f"Ø§Ø®ØªÙ„Ø§Ù: {disc['discrepancy']:.2f} ({disc['discrepancy_percent']:.2f}%)")
```

---

## ğŸ§ª ØªØ³Øª Ø³ÛŒØ³ØªÙ…

```bash
python test_dynamic_system.py
```

Ø§ÛŒÙ† Ø§Ø³Ú©Ø±ÛŒÙ¾Øª:
1. âœ… Ø´ÛŒØª Ø®Ø±ÛŒØ¯ Ø¬Ø¹Ù„ÛŒ Ø§ÛŒØ¬Ø§Ø¯ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
2. âœ… Mapping ØªØ¹Ø±ÛŒÙ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
3. âœ… Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ Ø±Ø§ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
4. âœ… Ø´ÛŒØª ÙØ±ÙˆØ´ Ø§ÛŒØ¬Ø§Ø¯ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
5. âœ… Ú¯Ø²Ø§Ø±Ø´â€ŒÙ‡Ø§ ØªÙˆÙ„ÛŒØ¯ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
6. âœ… Ù…ØºØ§ÛŒØ±Øªâ€ŒÙ‡Ø§ Ø±Ø§ Ø¨Ø±Ø±Ø³ÛŒ Ù…ÛŒâ€ŒÚ©Ù†Ø¯

---

## ğŸ¨ UI Components

### **1. FieldMappingDialog**
```python
from app.gui.financial.field_mapping_dialog import FieldMappingDialog

dialog = FieldMappingDialog(session, sheet_import_id=1)
dialog.exec()
```

**ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§:**
- Ø§Ù†ØªØ®Ø§Ø¨ Ù†ÙˆØ¹ Ø´ÛŒØª (Ø®Ø±ÛŒØ¯/ÙØ±ÙˆØ´/Ø¨ÙˆÙ†ÙˆØ³)
- ØªØ¹ÛŒÛŒÙ† Ù¾Ù„ØªÙØ±Ù… (Ø¨Ø±Ø§ÛŒ ÙØ±ÙˆØ´)
- Ø¬Ø¯ÙˆÙ„ mapping Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø³ØªÙˆÙ†
- ØªØ´Ø®ÛŒØµ Ø®ÙˆØ¯Ú©Ø§Ø±
- Ù†Ù…ÙˆÙ†Ù‡ Ø¯Ø§Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ù‡Ø± Ø³ØªÙˆÙ†

### **2. AdvancedReportWidget**
```python
from app.gui.financial.advanced_report_widget import AdvancedReportWidget

widget = AdvancedReportWidget(session)
widget.show()
```

**ÙˆÛŒÚ˜Ú¯ÛŒâ€ŒÙ‡Ø§:**
- Ø§Ù†ØªØ®Ø§Ø¨ Ù†ÙˆØ¹ Ú¯Ø²Ø§Ø±Ø´ (Label, Platform, Customer, Custom)
- ÙÛŒÙ„ØªØ±Ù‡Ø§ÛŒ Ù…ØªØ¹Ø¯Ø¯ (ØªØ§Ø±ÛŒØ®ØŒ Ù¾Ù„ØªÙØ±Ù…ØŒ Ù…Ø´ØªØ±ÛŒ)
- Ù‚Ø§Ù„Ø¨â€ŒÙ‡Ø§ÛŒ Ø¢Ù…Ø§Ø¯Ù‡ (ÙØ±ÙˆØ´ Ø§Ù…Ø±ÙˆØ²ØŒ Ù…Ø´ØªØ±ÛŒØ§Ù† Ø¨Ø±ØªØ±ØŒ ...)
- Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ú¯Ø²Ø§Ø±Ø´
- ØµØ§Ø¯Ø±Ø§Øª Ø¨Ù‡ Excel
- Ø°Ø®ÛŒØ±Ù‡/Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù‚Ø§Ù„Ø¨

---

## ğŸ“ Ù†Ù…ÙˆÙ†Ù‡ Mapping

### **Ø´ÛŒØª Ø®Ø±ÛŒØ¯ (Consumed)**

| Ø³ØªÙˆÙ† Ø¯Ø± Ø´ÛŒØª | Ù†Ù‚Ø´ Ø¯Ø± Ø³ÛŒØ³ØªÙ… | Ù†ÙˆØ¹ Ø¯Ø§Ø¯Ù‡ | Ø§Ø¬Ø¨Ø§Ø±ÛŒ |
|-------------|--------------|----------|--------|
| Label | account_id | text | âœ… |
| Email | email | text | âŒ |
| GOLD | gold_quantity | decimal | âœ… |
| Cost | purchase_cost | decimal | âœ… |
| Charge % | *ignore* | - | âŒ |
| Free Silver | silver_bonus | decimal | âŒ |

### **Ø´ÛŒØª ÙØ±ÙˆØ´ (Roblox)**

| Ø³ØªÙˆÙ† Ø¯Ø± Ø´ÛŒØª | Ù†Ù‚Ø´ Ø¯Ø± Ø³ÛŒØ³ØªÙ… | Ù†ÙˆØ¹ Ø¯Ø§Ø¯Ù‡ | Ø§Ø¬Ø¨Ø§Ø±ÛŒ |
|-------------|--------------|----------|--------|
| Account | account_id | text | âœ… |
| Gold Sold | sale_quantity | decimal | âœ… |
| Rate | sale_rate | decimal | âœ… |
| Customer | customer_code | text | âŒ |
| Staff Profit | staff_profit | decimal | âŒ |

**Ù†Ú©ØªÙ‡:** Ù¾Ù„ØªÙØ±Ù… Ø§Ø² `SheetImport.platform` Ú¯Ø±ÙØªÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯

---

## ğŸ” Ù†Ù‚Ø´â€ŒÙ‡Ø§ÛŒ (Target Fields) Ù…ÙˆØ¬ÙˆØ¯

| Ù†Ù‚Ø´ | ØªÙˆØ¶ÛŒØ­ |
|-----|-------|
| `account_id` | Label (Ú©Ù„ÛŒØ¯ Ø§ØµÙ„ÛŒ) |
| `email` | Ø§ÛŒÙ…ÛŒÙ„ Ø¢Ú©Ø§Ù†Øª |
| `supplier` | ØªØ§Ù…ÛŒÙ†â€ŒÚ©Ù†Ù†Ø¯Ù‡ |
| `gold_quantity` | Ù…Ù‚Ø¯Ø§Ø± Ú¯Ù„Ø¯ |
| `purchase_rate` | Ù†Ø±Ø® Ø®Ø±ÛŒØ¯ |
| `purchase_cost` | Ù‡Ø²ÛŒÙ†Ù‡ Ø®Ø±ÛŒØ¯ |
| `purchase_date` | ØªØ§Ø±ÛŒØ® Ø®Ø±ÛŒØ¯ |
| `silver_bonus` | Ø¨ÙˆÙ†ÙˆØ³ Ø³ÛŒÙ„ÙˆØ± |
| `sale_quantity` | Ù…Ù‚Ø¯Ø§Ø± ÙØ±ÙˆØ´ |
| `sale_rate` | Ù†Ø±Ø® ÙØ±ÙˆØ´ |
| `sale_type` | Ù†ÙˆØ¹ ÙØ±ÙˆØ´ (gold/silver) |
| `customer_code` | Ú©Ø¯ Ù…Ø´ØªØ±ÛŒ |
| `sale_date` | ØªØ§Ø±ÛŒØ® ÙØ±ÙˆØ´ |
| `staff_profit` | Ø³ÙˆØ¯ Ù¾Ø±Ø³Ù†Ù„ |
| `notes` | ÛŒØ§Ø¯Ø¯Ø§Ø´Øª |
| `status` | ÙˆØ¶Ø¹ÛŒØª |
| `ignore` | Ù†Ø§Ø¯ÛŒØ¯Ù‡ Ú¯Ø±ÙØªÙ‡ Ø´ÙˆØ¯ |

---

## ğŸ’¡ Ù†Ú©Ø§Øª Ù…Ù‡Ù…

### **1. ØªØ±ØªÛŒØ¨ Ø¹Ù…Ù„ÛŒØ§Øª**
- Ø§Ø¨ØªØ¯Ø§ **Ø®Ø±ÛŒØ¯Ù‡Ø§** Ø±Ø§ Import Ùˆ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ú©Ù†ÛŒØ¯
- Ø³Ù¾Ø³ **ÙØ±ÙˆØ´â€ŒÙ‡Ø§** Ø±Ø§ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ú©Ù†ÛŒØ¯
- Ø¯Ø± ØºÛŒØ± Ø§ÛŒÙ† ØµÙˆØ±ØªØŒ Ø®Ø·Ø§ÛŒ "Account ÛŒØ§ÙØª Ù†Ø´Ø¯" Ø¯Ø±ÛŒØ§ÙØª Ù…ÛŒâ€ŒÚ©Ù†ÛŒØ¯

### **2. Label Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ú©Ù„ÛŒØ¯**
- Label Ø¨Ø§ÛŒØ¯ Ø¯Ø± Ù‡Ù…Ù‡ Ø´ÛŒØªâ€ŒÙ‡Ø§ ÛŒÚ©ØªØ§ Ø¨Ø§Ø´Ø¯
- Label Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Foreign Key Ø¯Ø± Ù‡Ù…Ù‡ Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯

### **3. Ù¾Ù„ØªÙØ±Ù…**
- Ø¨Ø±Ø§ÛŒ Ø´ÛŒØªâ€ŒÙ‡Ø§ÛŒ ÙØ±ÙˆØ´ØŒ Ø­ØªÙ…Ø§Ù‹ Ù¾Ù„ØªÙØ±Ù… Ø±Ø§ Ù…Ø´Ø®Øµ Ú©Ù†ÛŒØ¯
- Ù¾Ù„ØªÙØ±Ù… Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø± Ø¨Ù‡ ØªÙ…Ø§Ù… ÙØ±ÙˆØ´â€ŒÙ‡Ø§ÛŒ Ø¢Ù† Ø´ÛŒØª Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯

### **4. ØªØ¨Ø¯ÛŒÙ„ Ø¯Ø§Ø¯Ù‡**
- Ø³ÛŒØ³ØªÙ… Ø¨Ù‡ ØµÙˆØ±Øª Ø®ÙˆØ¯Ú©Ø§Ø±:
  - Ú©Ø§Ù…Ø§ (,) Ø±Ø§ Ø¨Ù‡ Ù†Ù‚Ø·Ù‡ (.) ØªØ¨Ø¯ÛŒÙ„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯
  - Ø§Ø³Ù„Ø´ (/) Ø±Ø§ Ø¨Ù‡ Ù†Ù‚Ø·Ù‡ (.) ØªØ¨Ø¯ÛŒÙ„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ (Ø¨Ø±Ø§ÛŒ Ø§Ø¹Ø´Ø§Ø± Ø§ÛŒØ±Ø§Ù†ÛŒ)
  - ÙØ§ØµÙ„Ù‡â€ŒÙ‡Ø§ Ø±Ø§ Ø­Ø°Ù Ù…ÛŒâ€ŒÚ©Ù†Ø¯

### **5. Ù…ØºØ§ÛŒØ±Øªâ€ŒÚ¯ÛŒØ±ÛŒ**
- Ø³ÙˆØ¯ Ù…Ø­Ø§Ø³Ø¨Ù‡ Ø´Ø¯Ù‡ ØªÙˆØ³Ø· `CalculationEngine`
- Ø³ÙˆØ¯ Ù¾Ø±Ø³Ù†Ù„ Ø§Ø² ÙÛŒÙ„Ø¯ `staff_profit` Ø¯Ø± Ø¬Ø¯ÙˆÙ„ `sales`
- Ø§Ø®ØªÙ„Ø§Ù Ø¨ÛŒØ´ Ø§Ø² 1% Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† Ù…ØºØ§ÛŒØ±Øª Ø´Ù†Ø§Ø³Ø§ÛŒÛŒ Ù…ÛŒâ€ŒØ´ÙˆØ¯

---

## ğŸš¨ Ø±ÙØ¹ Ù…Ø´Ú©Ù„Ø§Øª

### **Ø®Ø·Ø§: "Ù‡ÛŒÚ† Field Mapping ØªØ¹Ø±ÛŒÙ Ù†Ø´Ø¯Ù‡"**
**Ø±Ø§Ù‡â€ŒØ­Ù„:** Ø§Ø¨ØªØ¯Ø§ Field Mapping Dialog Ø±Ø§ Ø¨Ø§Ø² Ú©Ù†ÛŒØ¯ Ùˆ Mapping Ø±Ø§ Ø§Ù†Ø¬Ø§Ù… Ø¯Ù‡ÛŒØ¯

### **Ø®Ø·Ø§: "Account ÛŒØ§ÙØª Ù†Ø´Ø¯"**
**Ø±Ø§Ù‡â€ŒØ­Ù„:** Ø§Ø¨ØªØ¯Ø§ Ø´ÛŒØª Ø®Ø±ÛŒØ¯ Ø±Ø§ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ú©Ù†ÛŒØ¯ØŒ Ø³Ù¾Ø³ ÙØ±ÙˆØ´

### **Ø®Ø·Ø§: "ÙÛŒÙ„Ø¯ Ø§Ø¬Ø¨Ø§Ø±ÛŒ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª"**
**Ø±Ø§Ù‡â€ŒØ­Ù„:** 
- Ø¨Ø±Ø±Ø³ÛŒ Ú©Ù†ÛŒØ¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø®Ø§Ù… Ú©Ø§Ù…Ù„ Ø¨Ø§Ø´Ù†Ø¯
- ÛŒØ§ ÙÛŒÙ„Ø¯ Ø±Ø§ Ø¨Ù‡ Ø¹Ù†ÙˆØ§Ù† "ØºÛŒØ± Ø§Ø¬Ø¨Ø§Ø±ÛŒ" ØªÙ†Ø¸ÛŒÙ… Ú©Ù†ÛŒØ¯

### **Ø®Ø·Ø§ Ø¯Ø± ØªØ¨Ø¯ÛŒÙ„ Ø¹Ø¯Ø¯**
**Ø±Ø§Ù‡â€ŒØ­Ù„:** 
- Ù…Ø·Ù…Ø¦Ù† Ø´ÙˆÛŒØ¯ ÙØ±Ù…Øª Ø¹Ø¯Ø¯ ØµØ­ÛŒØ­ Ø§Ø³Øª
- Ù†ÙˆØ¹ Ø¯Ø§Ø¯Ù‡ Ø±Ø§ Ø¨Ù‡ `decimal` ÛŒØ§ `integer` ØªØºÛŒÛŒØ± Ø¯Ù‡ÛŒØ¯

---

## ğŸ“š Ù…Ø«Ø§Ù„ Ú©Ø§Ù…Ù„

```python
from app.models.financial import FinancialSessionLocal, SheetImport, RawData, FieldMapping
from app.models.financial import SheetType, TargetField, DataType
from app.core.financial import DynamicDataProcessor, AdvancedReportBuilder

session = FinancialSessionLocal()

# 1. Ø§ÛŒØ¬Ø§Ø¯ SheetImport
sheet = SheetImport(
    sheet_name="December Purchases",
    sheet_type=SheetType.PURCHASE
)
session.add(sheet)
session.flush()

# 2. Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† RawData
raw = RawData(
    sheet_import_id=sheet.id,
    row_number=1,
    data={
        "Label": "A1054",
        "Email": "test@example.com",
        "GOLD": "535.60",
        "Cost": "452.18"
    }
)
session.add(raw)

# 3. ØªØ¹Ø±ÛŒÙ Mapping
mappings = [
    FieldMapping(sheet.id, "Label", TargetField.ACCOUNT_ID, DataType.TEXT, True),
    FieldMapping(sheet.id, "Email", TargetField.EMAIL, DataType.TEXT, False),
    FieldMapping(sheet.id, "GOLD", TargetField.GOLD_QUANTITY, DataType.DECIMAL, True),
    FieldMapping(sheet.id, "Cost", TargetField.PURCHASE_COST, DataType.DECIMAL, True)
]
for m in mappings:
    session.add(m)

session.commit()

# 4. Ù¾Ø±Ø¯Ø§Ø²Ø´
processor = DynamicDataProcessor(session)
stats = processor.process_sheet(sheet.id)

print(f"âœ… {stats['processed']} Ø³Ø·Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø´Ø¯")

# 5. Ú¯Ø²Ø§Ø±Ø´
builder = AdvancedReportBuilder(session)
df = builder.build_report({
    'report_type': 'label',
    'filters': {'label': 'A1054'}
})

print(df)

session.close()
```

---

## âœ… Ú†Ú©â€ŒÙ„ÛŒØ³Øª Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ

- [ ] Ù…Ø§ÛŒÚ¯Ø±ÛŒØ´Ù†: `python migrate_to_dynamic_system.py`
- [ ] ØªØ³Øª: `python test_dynamic_system.py`
- [ ] Import Ø´ÛŒØª Ø®Ø±ÛŒØ¯ Ø§Ø² Ú¯ÙˆÚ¯Ù„
- [ ] ØªØ¹Ø±ÛŒÙ Mapping Ø¨Ø±Ø§ÛŒ Ø´ÛŒØª Ø®Ø±ÛŒØ¯
- [ ] Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø´ÛŒØª Ø®Ø±ÛŒØ¯
- [ ] Import Ø´ÛŒØª ÙØ±ÙˆØ´ Ø§Ø² Ú¯ÙˆÚ¯Ù„
- [ ] ØªØ¹Ø±ÛŒÙ Mapping Ø¨Ø±Ø§ÛŒ Ø´ÛŒØª ÙØ±ÙˆØ´
- [ ] Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø´ÛŒØª ÙØ±ÙˆØ´
- [ ] ØªÙˆÙ„ÛŒØ¯ Ú¯Ø²Ø§Ø±Ø´ Label
- [ ] Ø¨Ø±Ø±Ø³ÛŒ Ù…ØºØ§ÛŒØ±Øªâ€ŒÙ‡Ø§

---

## ğŸ‰ Ù…ÙˆÙÙ‚ Ø¨Ø§Ø´ÛŒØ¯!

Ø³ÛŒØ³ØªÙ… Ù¾ÙˆÛŒØ§ Ø¢Ù…Ø§Ø¯Ù‡ Ø§Ø³Øª. Ø­Ø§Ù„Ø§ Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒØ¯ Ù‡Ø± Ø´ÛŒØªÛŒ Ø¨Ø§ Ù‡Ø± Ø³Ø§Ø®ØªØ§Ø±ÛŒ Ø±Ø§ Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± Ú©Ø¯ Ù¾Ø±Ø¯Ø§Ø²Ø´ Ú©Ù†ÛŒØ¯! ğŸš€
